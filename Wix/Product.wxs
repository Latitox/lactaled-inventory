<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    
    <?define UpgradeCode = "C1B3DD7F-94BA-488E-BB07-8E2907163826"?>
    
    <Product Id="*" 
             Name="Lactaled Inventory Service" 
             Language="1033" 
             Version="1.0.0.0" 
             Manufacturer="Lactaled" 
             UpgradeCode="$(var.UpgradeCode)">
             
        <Package InstallerVersion="200" 
                 Compressed="yes" 
                 InstallScope="perMachine" 
                 Comments="Servicio de inventario Lactaled" />
                 
        <MajorUpgrade DowngradeErrorMessage="Una versi칩n m치s nueva ya est치 instalada." />
        <MediaTemplate EmbedCab="yes" />
        
        <!-- Directorios -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="LactaledInventoryService"/>
            </Directory>
        </Directory>
        
        <!-- Componentes principales -->
        <Feature Id="MainFeature" Title="Servicio Inventario" Level="1">
            <ComponentGroupRef Id="ScriptComponents"/>
        </Feature>
        
        <!-- Scripts - TODOS los archivos necesarios -->
        <ComponentGroup Id="ScriptComponents" Directory="INSTALLFOLDER">
            <!-- Script principal de inventario -->
            <Component Id="GetInventarioScript" Guid="37F3F007-4870-4B5C-A2B0-DD3D2337380F">
                <File Id="GetInventarioPS1" 
                      Source="Scripts\Get-Inventario.ps1" 
                      KeyPath="yes"/>
            </Component>
            
            <!-- Script de instalaci칩n principal -->
            <Component Id="InstallLactaledScript" Guid="4873F007-4870-4B5C-A2B0-DD3D2337381A">
                <File Id="InstallLactaledPS1" 
                      Source="Scripts\Install-Lactaled.ps1" 
                      KeyPath="yes"/>
            </Component>
            
            <!-- Script de despliegue alternativo -->
            <Component Id="DeployInventarioScript" Guid="5873F007-4870-4B5C-A2B0-DD3D2337382B">
                <File Id="DeployInventarioPS1" 
                      Source="Scripts\Deploy-Inventario.ps1" 
                      KeyPath="yes"/>
            </Component>
            
            <!-- Icono de bandeja -->
            <Component Id="TrayIconScript" Guid="6873F007-4870-4B5C-A2B0-DD3D2337383C">
                <File Id="LactaledTrayPS1" 
                      Source="Scripts\Lactaled-Tray.ps1" 
                      KeyPath="yes"/>
            </Component>
            
            <!-- Crear carpetas necesarias -->
            <Component Id="CreateDataDirs" Guid="7873F007-4870-4B5C-A2B0-DD3D2337384D">
                <CreateFolder Directory="C:\ProgramData\Lactaled\Inventario"/>
                <CreateFolder Directory="C:\ProgramData\Lactaled\Logs"/>
                <RegistryValue Root="HKCU" Key="SOFTWARE\Lactaled\InventoryService" 
                             Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" KeyPath="yes"/>
            </Component>
        </ComponentGroup>
        
        <!-- CustomAction para ejecutar el instalador -->
        <CustomAction Id="RunInstallScript" 
                      Execute="deferred" 
                      Impersonate="no" 
                      Return="check" 
                      File="powershell.exe"
                      ExeCommand="-ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]Install-Lactaled.ps1&quot; -Silent"/>
        
        <InstallExecuteSequence>
            <Custom Action="RunInstallScript" After="InstallFiles">NOT Installed</Custom>
        </InstallExecuteSequence>
        
    </Product>
</Wix>