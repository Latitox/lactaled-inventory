<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    
    <?define UpgradeCode = "C1B3DD7F-94BA-488E-BB07-8E2907163826"?>
    
    <Product Id="*" 
             Name="Lactaled Inventory Service" 
             Language="1033" 
             Version="1.0.0.0" 
             Manufacturer="Lactaled" 
             UpgradeCode="$(var.UpgradeCode)">
             
        <Package InstallerVersion="200" 
                 Compressed="yes" 
                 InstallScope="perMachine" 
                 Comments="Servicio de inventario Lactaled" />
                 
        <MajorUpgrade DowngradeErrorMessage="Una versión más nueva ya está instalada." />
        <MediaTemplate EmbedCab="yes" />
        
        <!-- Directorios necesarios -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="Lactaled\InventoryService"/>
            </Directory>
            <Directory Id="CommonAppDataFolder">
                <Directory Id="LactaledData" Name="Lactaled">
                    <Directory Id="InventarioDir" Name="Inventario"/>
                    <Directory Id="LogsDir" Name="Logs"/>
                </Directory>
            </Directory>
        </Directory>
        
        <!-- Componentes principales -->
        <Feature Id="MainFeature" Title="Servicio Inventario" Level="1">
            <ComponentGroupRef Id="ScriptComponents"/>
            <ComponentGroupRef Id="FolderComponents"/>
            <ComponentGroupRef Id="ScheduledTaskComponents"/>
        </Feature>
        
        <!-- Scripts -->
        <ComponentGroup Id="ScriptComponents" Directory="INSTALLFOLDER">
            <Component Id="MainScript" Guid="37F3F007-4870-4B5C-A2B0-DD3D2337380F">
                <File Id="GetInventarioPS1" 
                        Source="Scripts\Get-Inventario.ps1" 
                        KeyPath="yes"/>

                <File Id="InstallLactaledPS1" 
                        Source="Scripts\Install-Lactaled.ps1" 
                        KeyPath="yes"/>
            </Component>
            <Component Id="DeployScript" Guid="4873F007-4870-4B5C-A2B0-DD3D2337381A">
                <File Id="DeployInventarioPS1" 
                      Source="Scripts\Deploy-Inventario.ps1" 
                      KeyPath="yes"/>
            </Component>
        </ComponentGroup>
        
        <!-- Carpetas necesarias -->
        <ComponentGroup Id="FolderComponents">
            <Component Id="InventarioFolder" Guid="5873F007-4870-4B5C-A2B0-DD3D2337382B" Directory="InventarioDir">
                <CreateFolder/>
                <RegistryValue Root="HKCU" Key="SOFTWARE\Lactaled" Type="string" Value="" KeyPath="yes"/>
            </Component>
            <Component Id="LogsFolder" Guid="6873F007-4870-4B5C-A2B0-DD3D2337383C" Directory="LogsDir">
                <CreateFolder/>
                <RegistryValue Root="HKCU" Key="SOFTWARE\Lactaled" Type="string" Value="" KeyPath="yes"/>
            </Component>
        </ComponentGroup>
        
        <!-- Tarea programada - Ejecutar después de instalar -->
        <ComponentGroup Id="ScheduledTaskComponents" Directory="INSTALLFOLDER">
            <Component Id="ScheduledTask" Guid="7873F007-4870-4B5C-A2B0-DD3D2337384D">
                <util:TaskScheduler Id="CreateInventoryTask" 
                    Name="LactaledInventory"
                    Execute="powershell.exe"
                    Arguments="-ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]Deploy-Inventario.ps1&quot; -Silent"
                    Begin="Install" 
                    Schedule="ONSTART"/>
                
                <RegistryValue Root="HKCU" Key="SOFTWARE\Lactaled" Type="string" Value="" KeyPath="yes"/>
            </Component>
        </ComponentGroup>
        
        <!-- Acciones personalizadas para ejecutar PowerShell -->
        <CustomAction Id="RunDeployScript" 
                      Execute="deferred" 
                      Impersonate="no" 
                      Return="check" 
                      ExeCommand="powershell.exe -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]Deploy-Inventario.ps1&quot; -Silent"/>
        
        <InstallExecuteSequence>
            <Custom Action="RunDeployScript" After="InstallFiles">NOT Installed</Custom>
        </InstallExecuteSequence>
        
    </Product>
</Wix>